<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>まごころアンケート</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .item-block { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    label { display: block; margin: 5px 0 2px; }
    textarea { width: 100%; height: 60px; }
    select { width: 100%; }
    button { margin-top: 10px; }
    #thankYouMessage { display: none; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h1>まごころアンケート</h1>
  <form id="form">
    <label>店番</label>
    <input type="text" id="storeNumber" name="storeNumber" />

    <label>店名</label>
    <input type="text" id="storeName" name="storeName" />

    <label>お名前（匿名可）</label>
    <input type="text" id="userName" name="userName" required />

    <div id="itemsContainer">
      <div class="item-block">
        <label>分類</label>
        <select name="category">
          <option value="">選択してください</option>
          <option value="接客">接客</option>
          <option value="商品">商品</option>
          <option value="設備">設備</option>
        </select>

        <label>問題点</label>
        <textarea name="problem"></textarea>

        <label>要望</label>
        <textarea name="request"></textarea>
      </div>
    </div>

    <button type="button" id="addItem">＋ 問題点・要望を追加</button><br>
    <button type="submit">送信</button>
  </form>

  <div id="thankYouMessage">送信ありがとうございました！</div>

  <script>
    const form = document.getElementById("form");
    const storeNumber = document.getElementById("storeNumber");
    const storeName = document.getElementById("storeName");
    const thankYouMessage = document.getElementById("thankYouMessage");
    const itemsContainer = document.getElementById("itemsContainer");
    const addItemButton = document.getElementById("addItem");

    // 項目追加ボタン処理
    addItemButton.addEventListener("click", () => {
      const block = document.createElement("div");
      block.className = "item-block";
      block.innerHTML = `
        <label>分類</label>
        <select name="category">
          <option value="">選択してください</option>
          <option value="接客">接客</option>
          <option value="商品">商品</option>
          <option value="設備">設備</option>
        </select>

        <label>問題点</label>
        <textarea name="problem"></textarea>

        <label>要望</label>
        <textarea name="request"></textarea>
      `;
      itemsContainer.appendChild(block);
    });

    // フォーム送信処理
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const userName = document.getElementById("userName").value.trim();
      if (!userName) {
        alert("お名前を入力してください。");
        return;
      }

      const data = {
        storeNumber: storeNumber.value,
        storeName: storeName.value,
        userName,
        items: []
      };

      const itemBlocks = document.querySelectorAll(".item-block");
      for (const block of itemBlocks) {
        const category = block.querySelector("select[name='category']").value.trim();
        const problem = block.querySelector("textarea[name='problem']").value.trim();
        const request = block.querySelector("textarea[name='request']").value.trim();

        if (category || problem || request) {
          data.items.push({ category, problem, request });
        }
      }

      if (!data.items.length) {
        alert("少なくとも1つの項目を入力してください。");
        return;
      }

      // CORSプリフライト回避（JSONではなくURLエンコードで送信）
      const formData = new URLSearchParams();
      formData.append("payload", JSON.stringify(data));

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbyY4qkvDNmHwhKJ0QwDohcCPOWl1y2jdAjwgZrNu27ZBao6xHF2tuMwj3bxaCIF3JnMYA/exec", {
          method: "POST",
          body: formData
        });

        const result = await response.json();

        if (result.result === "OK") {
          form.style.display = "none";
          thankYouMessage.style.display = "block";
        } else {
          alert("送信に失敗しました: " + result.reason);
        }

      } catch (error) {
        console.error("送信エラー:", error);
        alert("通信エラーが発生しました。もう一度お試しください。");
      }
    });
  </script>
</body>
</html>
